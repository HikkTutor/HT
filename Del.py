__version__ = (1, 0, 8)
#ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤Â© Copyright 2024
#ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤ã…¤https://t.me/unnic
# ğŸ”’ã…¤ã…¤ã…¤ã…¤ã…¤Licensed under the GNU AGPLv3
# ğŸŒã…¤ã…¤https://www.gnu.org/licenses/agpl-3.0.html
#â”â”“â”â”â”“â”â”â”â”“â”â”â”â”“â”â”â”â”â”â”â”â”“â”â”â”â”â”â”â”“â”â”â”â”â”â”â”â”â”â”â”â”
#â”ƒâ”ƒâ”â”ƒâ”ƒâ”â”â”ƒâ”ƒâ”â”â”ƒâ”ƒâ”â”â”ƒâ”â”“â”â”“â”ƒâ”â”â”â”â”â”›â”—â”“â”â”â”â”â”â”â”â”â”â”â”
#â”ƒâ”—â”â”›â”ƒâ”â”“â”ƒâ”ƒâ”â”“â”ƒâ”ƒâ”â”“â”—â”›â”ƒâ”ƒâ”—â”›â”â”“â”â”“â”—â”“â”â”›â”â”â”â”“â”â”â”“â”â”â”â”
#â”ƒâ”â”â”“â”ƒâ”£â”«â”ƒâ”—â”›â”›â”ƒâ”—â”›â”›â”â”â”ƒâ”ƒâ”â”â”ƒâ”ƒâ”ƒâ”ƒâ”â”ƒâ”ƒâ”â”ƒâ”â”“â”ƒâ”ƒâ”â”›â”â”â”â”
#â”ƒâ”ƒâ”â”ƒâ”ƒâ”ƒâ”ƒâ”ƒâ”â”“â”“â”ƒâ”â”“â”“â”â”â”›â”—â”“â”â”ƒâ”—â”›â”ƒâ”â”ƒâ”—â”“â”ƒâ”—â”›â”ƒâ”ƒâ”ƒâ”â”â”â”â”
#â”—â”›â”â”—â”›â”—â”›â”—â”›â”—â”›â”—â”›â”—â”›â”â”—â”â”â”›â”â”—â”â”â”›â”â”—â”â”›â”—â”â”â”›â”—â”›â”â”â”â”â”
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# load from: t.me:HikkTutor 
# meta developer:@HikkTutor 
# author: @unnic
# name: Del
#â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
#â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
#â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•
#â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—
#â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
#â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•â•šâ•â•â–‘â–‘â•šâ•â•â•â•šâ•â•â–‘â•šâ•â•â•â•â•

from telethon import types  # type: ignore
from telethon.errors import ChatAdminRequiredError  # type: ignore
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)


@loader.tds
class DelMod(loader.Module):
    """ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² Ğ² Ñ‡Ğ°Ñ‚Ğµ"""

    strings = {
        "name": "Del",
        "author": "@HikkTutor",
        "no_deleted_accounts": "<emoji document_id=5341509066344637610>ğŸ˜</emoji> <b>Ğ—Ğ´ĞµÑÑŒ Ğ½ĞµÑ‚ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°</b>",
        "deleted_accounts_removed": "<emoji document_id=5328302454226298081>ğŸ«¥</emoji> <b>Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ {} ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²</b>",
        "no_messages": "<emoji document_id=5341509066344637610>ğŸ˜</emoji> <b>Ğ—Ğ´ĞµÑÑŒ Ğ½ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²</b>",
        "messages_removed": "<emoji document_id=5328302454226298081>ğŸ«¥</emoji> <b>Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ {} ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²</b>",
        "not_admin": "<emoji document_id=5787544344906959608>â„¹ï¸</emoji> <b>ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.</b>",
        "not_group": "<emoji document_id=5787313834012184077>ğŸ˜€</emoji> <b>Ğ­Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿</b>",
        "error": "<emoji document_id=5787544344906959608>â„¹ï¸</emoji> <b>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° {}: {}</b>",
        "searching": "<emoji document_id=5188311512791393083>ğŸ”</emoji> <b>ĞŸĞ¾Ğ¸ÑĞº ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²</b>",
        "searching_messages": "<emoji document_id=5188311512791393083>ğŸ”</emoji> <b>ĞŸĞ¾Ğ¸ÑĞº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²</b>",
        "limit_reached": "âš ï¸ <b>Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹.\nĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²?</b>",
        "continue_button": "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ",
        "stop_button": "Ğ—Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ",
    }

    async def client_ready(self, client, db):
        self._client = client
        self.db = db
        self.removed_count = 0

    @loader.command()
    async def delete(self, message: types.Message):
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹ Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°"""
        chat = await message.get_chat()

        if isinstance(chat, types.User):
            await utils.answer(message, self.strings("not_group"))
            return

        if not chat.admin_rights and not chat.creator:
            await utils.answer(message, self.strings("not_admin"))
            return

        removed_count = 0
        edit_message = await utils.answer(message, self.strings("searching"))
        if not edit_message:
            edit_message = message

        async for user in self._client.iter_participants(chat):
            if user.deleted:
                try:
                    await self._client.kick_participant(chat, user)
                    removed_count += 1
                except ChatAdminRequiredError:
                    await utils.answer(message, self.strings("not_admin"))
                    return
                except Exception as e:
                    await utils.answer(message, self.strings("error").format(user.id, str(e)))
                    return

        if removed_count == 0:
            await edit_message.edit(self.strings("no_deleted_accounts"))
        else:
            await edit_message.edit(self.strings("deleted_accounts_removed").format(removed_count))

    @loader.command()
    async def delmsg(self, message: types.Message):
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°"""
        chat = await message.get_chat()

        if isinstance(chat, types.User):
            await utils.answer(message, self.strings("not_group"))
            return

        if not chat.admin_rights and not chat.creator:
            await utils.answer(message, self.strings("not_admin"))
            return

        self.removed_count = 0
        edit_message = await utils.answer(message, self.strings("searching_messages"))
        if not edit_message:
            edit_message = message

        offset_id = None
        while True:
            if offset_id is None:
                offset_id = 0

            logger.debug(f"Fetching messages with offset_id: {offset_id}")
            messages = await self._client.get_messages(chat, offset_id=offset_id, reverse=True, limit=100)
            logger.debug(f"Fetched {len(messages)} messages")

            if not messages:
                break

            for msg in messages:
                if msg.sender and isinstance(msg.sender, types.User) and msg.sender.deleted:
                    if self.removed_count >= 100:
                        break
                    try:
                        await msg.delete()
                        self.removed_count += 1
                    except ChatAdminRequiredError:
                        await utils.answer(message, self.strings("not_admin"))
                        return
                    except Exception as e:
                        await utils.answer(message, self.strings("error").format(msg.sender.id, str(e)))
                        return

            if messages:
                offset_id = messages[-1].id
                logger.debug(f"Updated offset_id to: {offset_id}")
            else:
                break

            if self.removed_count >= 100:
                await self.inline.form(
                    message=edit_message,
                    text=self.strings("limit_reached"),
                    reply_markup=[
                        [
                            {
                                "text": self.strings("continue_button"),
                                "callback": self.continue_delmsg,
                                "args": (edit_message.id,)
                            },
                            {
                                "text": self.strings("stop_button"),
                                "callback": self.stop_delmsg,
                                "args": (edit_message.id,)
                            }
                        ]
                    ]
                )
                return

        if self.removed_count == 0:
            await edit_message.edit(self.strings("no_messages"))
        else:
            await edit_message.edit(self.strings("messages_removed").format(self.removed_count))

    async def continue_delmsg(self, call, message_id):
        message = await call.get_message()
        await message.edit(self.strings("searching_messages"))
        await self.delmsg(message)

    async def stop_delmsg(self, call, message_id):
        message = await call.get_message()
        await message.edit(self.strings("messages_removed").format(self.removed_count))
        await call.delete()

        # Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•! - Ğ’ĞµÑ€ÑĞ¸Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ Ğ¿Ğ¾ĞºĞ°-Ñ‡Ñ‚Ğ¾ ÑÑ‹Ñ€Ğ¾Ğ²Ğ°Ñ‚Ğ°.
        # Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•! - ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ²Ğ¾ÑÑ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğº API ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
        # Ğ’Ğ½ĞµĞ´Ñ€Ñ‘Ğ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹, Ğ¾Ñ‚ Ğ¼Ñ‘Ñ€Ñ‚Ğ²Ñ‹Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ².
        # Ğ˜Ğ½Ğ»Ğ°Ğ¹Ğ½ "Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹" Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµÑ‚Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ.
        # ĞŸÑ€ĞµĞ¶Ğ´Ğµ Ñ‡ĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ‚ÑŒ, Ğ¿Ğ¾Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ 787 Ñ€Ğ°Ğ·.